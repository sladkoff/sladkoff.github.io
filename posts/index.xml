<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on Leonid Koftun</title><link>https://blog.sldk.de/posts/</link><description>Recent content in Posts on Leonid Koftun</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>&lt;a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0&lt;/a></copyright><lastBuildDate>Fri, 26 Feb 2021 00:00:00 +0000</lastBuildDate><atom:link href="https://blog.sldk.de/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Setting up a Grafana Kiosk on a Raspberry Pi with Ansible</title><link>https://blog.sldk.de/2021/02/setting-up-a-grafana-kiosk-on-a-raspberry-pi-with-ansible/</link><pubDate>Fri, 26 Feb 2021 00:00:00 +0000</pubDate><guid>https://blog.sldk.de/2021/02/setting-up-a-grafana-kiosk-on-a-raspberry-pi-with-ansible/</guid><description>I was bored, I had a spare TV screen and a Raspberry Pi 3. I also love watching colorful charts on Grafana üìà
As I&amp;rsquo;m currently learning about Ansible, I decided to write a playbook that sets up a Headless Raspberry Pi in Grafana Kiosk mode.
This quick guide shows you how to create a Kiosk of your own.
You&amp;rsquo;ll need:
A Raspberry Pi with an empty SD card Ansible on your local machine A display or TV to connect to your Raspberry A Grafana instance that is reachable by the Raspberry Installing the OS I used the GUI rpi-imager to bootstrap my SD card with Raspberry Pi OS Lite (32bit) for my Raspberry.</description><content type="html"><![CDATA[<p>I was bored, I had a spare TV screen and a Raspberry Pi 3.
I also love watching colorful charts on <a href="https://grafana.com/">Grafana</a> üìà</p>
<p>As I&rsquo;m currently learning about <a href="https://www.ansible.com/">Ansible</a>,
I decided to write a playbook that sets up a Headless Raspberry Pi in Grafana Kiosk mode.</p>
<p>This quick guide shows you how to create a Kiosk of your own.</p>
<p>You&rsquo;ll need:</p>
<ul>
<li>A Raspberry Pi with an empty SD card</li>
<li>Ansible on your local machine</li>
<li>A display or TV to connect to your Raspberry</li>
<li>A Grafana instance that is reachable by the Raspberry</li>
</ul>
<h2 id="installing-the-os">Installing the OS</h2>
<p>I used the GUI <a href="https://github.com/raspberrypi/rpi-imager">rpi-imager</a> to bootstrap my SD card with
<strong>Raspberry Pi OS Lite (32bit)</strong> for my Raspberry. I think it&rsquo;s quick and easy and offers you some distro options
to choose from.</p>
<p>You can get the tool from the AUR if you&rsquo;re using Arch:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yay -S rpi-imager
</code></pre></div><p>Here&rsquo;s a screenshot of the GUI (select an image, select SD card, write!):</p>
<p><img src="/img/posts/grafana-kiosk-ansible/rpi-imager-screenshot.png" alt="rpi-imager"></p>
<p>To make the raspberry auto-connect to your WiFi on boot, create a new file <code>wpa_supplicant.conf</code> inside the <code>boot</code>
directory of your flashed SD card with the following contents.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
country=&lt;Insert 2 letter ISO 3166-1 country code here&gt;

network={
 ssid=&#34;&lt;Name of your wireless LAN&gt;&#34;
 psk=&#34;&lt;Password for your wireless LAN&gt;&#34;
}
</code></pre></div><p>To enable remote access over ssh after boot, create an empty file called <code>ssh</code> inside the <code>boot</code> directory as well.</p>
<h2 id="installing-grafana-kiosk">Installing grafana-kiosk</h2>
<p><a href="https://github.com/grafana/grafana-kiosk">grafana-kiosk</a> is a simple wrapper script that starts a fullscreen Chrome session
and opens a configured Grafana URL with optional authentication.
This Grafana URL usually points to a <a href="https://grafana.com/docs/grafana/latest/dashboards/playlist/">Grafana Playlist</a>
which switches between different Grafana dashboards.</p>
<p>I wrote a simple <a href="https://github.com/sladkoff/ansible-role-grafana-kiosk">Ansible role</a> to set up Headless Raspberry Pi Grafana Kiosks ‚Ñ¢Ô∏è.</p>
<h3 id="ansible-playbook">Ansible Playbook</h3>
<p>Here&rsquo;s my personal <a href="https://github.com/sladkoff/ansible-playbook-grafana-kiosk">Ansible playbook</a>.</p>
<p>It assumes that you have a fresh Raspberry with no graphical environment. Like what we&rsquo;ve set up during &ldquo;<a href="#installing-the-os">Installing the OS</a>&rdquo;.</p>
<p>The playbook will install and configure the following things to autostart on boot:</p>
<ul>
<li>openbox</li>
<li>chromium</li>
<li>grafana-kiosk</li>
</ul>
<p>To get started on your own RPI, you can fork <a href="https://github.com/sladkoff/ansible-playbook-grafana-kiosk">my repo</a> and
apply at least the following changes:</p>
<h4 id="rolesssh-keystasksmainyml">roles/ssh-keys/tasks/main.yml</h4>
<p>This role contains tasks to disable password login via ssh and upload ssh keys to the RPI. You can either get rid of
this if you don&rsquo;t need it or provide your own ssh keys:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># roles/ssh-keys/tasks/main.yml</span>
---
- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Deploy SSH Key</span>
  <span style="color:#f92672">ansible.posix.authorized_key</span>:
    <span style="color:#f92672">user</span>: <span style="color:#ae81ff">pi</span>
    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
    <span style="color:#f92672">key</span>: <span style="color:#ae81ff">&lt;URL-OR-FILE-TO-YOUR-SSH-KEYS&gt;</span>
    <span style="color:#f92672">validate_certs</span>: <span style="color:#66d9ef">False</span>
  <span style="color:#f92672">notify</span>:
    - <span style="color:#ae81ff">Restart sshd</span>

- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Disable Password Authentication</span>
  <span style="color:#f92672">lineinfile</span>:
    <span style="color:#f92672">dest</span>: <span style="color:#ae81ff">/etc/ssh/sshd_config</span>
    <span style="color:#f92672">regexp</span>: <span style="color:#e6db74">&#39;^PasswordAuthentication&#39;</span>
    <span style="color:#f92672">line</span>: <span style="color:#e6db74">&#34;PasswordAuthentication no&#34;</span>
    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
    <span style="color:#f92672">backup</span>: <span style="color:#66d9ef">yes</span>
  <span style="color:#f92672">notify</span>:
    - <span style="color:#ae81ff">Restart sshd</span>
</code></pre></div><h4 id="hostsyaml">hosts.yaml</h4>
<p>Provide the IP of your RPI in the <code>hosts.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># hosts.yaml</span>
<span style="color:#f92672">grafana_kiosk</span>:
  <span style="color:#f92672">hosts</span>:
    <span style="color:#f92672">grafana_kiosk_rpi_tv</span>:
      <span style="color:#f92672">ansible_host</span>: <span style="color:#e6db74">&#34;&lt;YOUR-RASPBERRY-IP-HERE&gt;&#34;</span>

<span style="color:#f92672">all</span>:
  <span style="color:#f92672">children</span>:
    <span style="color:#f92672">grafana_kiosk</span>:
</code></pre></div><h4 id="filesmy-grafana-kiosk-configyaml">files/my-grafana-kiosk-config.yaml</h4>
<p>Provide a configuration for the grafana-kiosk utility script, this is where you specify the path to the Grafana instance
and Playlist ID that you want to display on your kiosk:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># my-grafana-kiosk-config.yaml</span>
<span style="color:#f92672">general</span>:
  <span style="color:#f92672">kiosk-mode</span>: <span style="color:#ae81ff">full</span>
  <span style="color:#f92672">autofit</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#f92672">lxde</span>: <span style="color:#66d9ef">false</span>

<span style="color:#f92672">target</span>:
  <span style="color:#f92672">login-method</span>: <span style="color:#ae81ff">local</span>
  <span style="color:#f92672">username</span>: <span style="color:#ae81ff">pi-grafana-kiosk</span>
  <span style="color:#f92672">password</span>: <span style="color:#ae81ff">pi-grafana-kiosk-password</span>
  <span style="color:#f92672">playlist</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#f92672">URL</span>: <span style="color:#ae81ff">https://&lt;YOUR-GRAFANA-HOST-HERE&gt;/playlists/play/&lt;YOUR-GRAFANA-PLAYLIST-ID&gt;?kiosk&amp;autofitpanels</span>
  <span style="color:#f92672">ignore-certificate-errors</span>: <span style="color:#66d9ef">false</span>

</code></pre></div><p>‚èØ Run the playbook in the repo directory</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ansible-galaxy install -r requirements.yaml
ansible-playbook install-grafana-kiosk -i hosts.yaml --ask-pass
</code></pre></div><p>You&rsquo;ll need to connecto the RPI to a screen and reboot it. If all went well, you should be greeted with your Grafana Playlist
after booting.</p>
<p>If there are still issues with my Ansible voodoo, feel free to create a PR on Github üò∏</p>
]]></content></item><item><title>Introduction to GitOps on Kubernetes with Flux v2</title><link>https://blog.sldk.de/2021/02/introduction-to-gitops-on-kubernetes-with-flux-v2/</link><pubDate>Fri, 19 Feb 2021 00:00:00 +0000</pubDate><guid>https://blog.sldk.de/2021/02/introduction-to-gitops-on-kubernetes-with-flux-v2/</guid><description>Today we&amp;rsquo;re having a look at how to set up a GitOps pipeline for your Kubernetes cluster with Flux v2.
We will first go through some core concepts of Flux and then create our first GitOps workflow.
You will need access to a Kubernetes cluster, a shell interface and a Github account to follow this guide. Note that you can use any git provider (Gitlab, Bitbucket, custom) but you&amp;rsquo;ll have to modify the provided example commands.</description><content type="html"><![CDATA[<p>Today we&rsquo;re having a look at how to set up a GitOps pipeline for your Kubernetes cluster with <a href="https://toolkit.fluxcd.io/">Flux v2</a>.</p>
<p>We will first go through some core concepts of Flux and then create our first GitOps workflow.</p>
<p>You will need access to a Kubernetes cluster, a shell interface and a Github account to follow this guide. Note that you
can use any git provider (Gitlab, Bitbucket, custom) but you&rsquo;ll have to modify the provided example commands.</p>
<h2 id="what-is-gitops">What is GitOps?</h2>
<blockquote>
<p>GitOps is a way of managing your infrastructure and applications so that whole system is described declaratively and version controlled (most likely in a Git repository), and having an automated process that ensures that the deployed environment matches the state specified in a repository.</p>
<p>&ndash; <a href="https://toolkit.fluxcd.io/core-concepts/#gitops">https://toolkit.fluxcd.io/core-concepts/#gitops</a></p>
</blockquote>
<p>In Kubernetes practice this means that <code>git</code> is used over <code>kubectl</code> (<code>helm</code>, etc) to perform operations tasks against the cluster.</p>
<p>Pushing to <code>master</code> triggers a deployment to the cluster. We can work with branches and Merge Requests to diff and
review changes to the desired cluster state. We can audit past cluster states with <code>git log</code>. We can rollback a change
using <code>git revert</code>.</p>
<h2 id="what-is-flux-v2">What is Flux v2?</h2>
<p>Flux v2 is a Toolkit for building GitOps workflows on Kubernetes.</p>
<p>In simplified terms, Flux v2 is deployed to a Kubernetes cluster and configured to watch git repositories containing
Kubernetes manifests.</p>
<p><img src="/img/posts/fluxcd/gitops-toolkit.png" alt="GitOps Toolkit"></p>
<p>As Flux watches all our repos and pulls the changes into the cluster, we can focus on writing our Kubernetes manifests.
We don&rsquo;t have to worry about client-side tooling and pushing the changes from every git repo into the cluster.
This is what GitOps is about.</p>
<p>We will come back to the individual Flux components once we&rsquo;ve installed them in the upcoming steps.</p>
<h2 id="installing-flux-v2">Installing Flux v2</h2>
<p>We&rsquo;ll follow the official docs and use the <code>flux</code> CLI tool.</p>
<p>You can install it with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -s https://toolkit.fluxcd.io/install.sh | sudo bash

<span style="color:#75715e"># enable completions in ~/.bash_profile</span>
. &lt;<span style="color:#f92672">(</span>flux completion bash<span style="color:#f92672">)</span>
</code></pre></div><p>The <code>flux bootstrap</code> command will ensure that:</p>
<ol>
<li>A new GitOps repository for our manifests is created on Github</li>
<li>A <code>flux-system</code> namespace with all Flux components is configured on our cluster</li>
<li>The Flux controllers are set up to sync with our new git repository</li>
</ol>
<p>‚ÑπÔ∏è Note that there&rsquo;s also <a href="https://toolkit.fluxcd.io/guides/installation/#bootstrap-with-terraform">Terraform Provider</a> as an alternative installation method.</p>
<p>The following snippet shows an annotated bootstrap command.
Feel free to play around with <code>flux bootstrap --help</code> to get to know all available options.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">export GITHUB_TOKEN<span style="color:#f92672">=</span>&lt;your-gitlab-token-here&gt; <span style="color:#75715e"># 1</span>

flux bootstrap <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  github <span style="color:#ae81ff">\ </span>                     <span style="color:#75715e"># 2</span>
  --owner &lt;your-github-user&gt; <span style="color:#ae81ff">\ </span> <span style="color:#75715e"># 3</span>
  --repository cluster-name <span style="color:#ae81ff">\ </span>  <span style="color:#75715e"># 4</span>
  --personal <span style="color:#ae81ff">\ </span>                 <span style="color:#75715e"># 5</span>
  --private <span style="color:#ae81ff">\ </span>                  <span style="color:#75715e"># 6</span>
  --path cluster <span style="color:#ae81ff">\ </span>             <span style="color:#75715e"># 7</span>
  --branch master               <span style="color:#75715e"># 8</span>
</code></pre></div><ol>
<li>We&rsquo;re going to need to give <code>flux</code> access to our Github account so that it can manage our GitOps repository on our behalf.
You can generate a new Personal Access Token in <a href="https://github.com/settings/tokens">Github Settings</a>.</li>
<li>We need to tell Flux that we&rsquo;re using Github as git provider. You can also use Gitlab and generic git servers.</li>
<li>The Github username.</li>
<li>The name of our git repository.</li>
<li>(Optional) We&rsquo;re creating a personal Github repo.</li>
<li>(Optional) We&rsquo;re starting out with a private Github repo.</li>
<li>(Optional) A path inside the repository to be watched by Flux.</li>
<li>(Optional) The git branch to be watched by Flux.</li>
</ol>
<p>The bootstrap command is interactive and will let you know about the progress and state of the installation.</p>
<p>This is all you need to get up and running with Flux. Note that the boostrap command is idempotent
and can also be used with an existing GitOps repository.</p>
<h2 id="inspecting-the-flux-components-">Inspecting the Flux components üïµ</h2>
<h3 id="the-flux-system-namespace">The flux-system namespace</h3>
<p>Let&rsquo;s take a look at what was deployed to the k8s cluster for us.</p>
<pre class="command-line" data-user="leo" data-host="sldk.de" data-filter-output="out:"><code class="language-bash"># Let&#39;s have a look at the Flux controllers...
kubectl get pods -n flux-system
out:NAME                                      READY   STATUS    RESTARTS   AGE
out:helm-controller-c858b9c65-v8pgr           1/1     Running   28         17d
out:kustomize-controller-6767b8fd78-8ptd4     1/1     Running   30         17d
out:notification-controller-db467b4fb-pt9tc   1/1     Running   29         17d
out:source-controller-7b4d748b45-2blvd        1/1     Running   28         17d
# And the custom resource definitions...
kubectl get crd -o name | grep flux
out:customresourcedefinition.apiextensions.k8s.io/alerts.notification.toolkit.fluxcd.io
out:customresourcedefinition.apiextensions.k8s.io/buckets.source.toolkit.fluxcd.io
out:customresourcedefinition.apiextensions.k8s.io/gitrepositories.source.toolkit.fluxcd.io
out:customresourcedefinition.apiextensions.k8s.io/helmcharts.source.toolkit.fluxcd.io
out:customresourcedefinition.apiextensions.k8s.io/helmreleases.helm.toolkit.fluxcd.io
out:customresourcedefinition.apiextensions.k8s.io/helmrepositories.source.toolkit.fluxcd.io
out:customresourcedefinition.apiextensions.k8s.io/kustomizations.kustomize.toolkit.fluxcd.io
out:customresourcedefinition.apiextensions.k8s.io/providers.notification.toolkit.fluxcd.io
out:customresourcedefinition.apiextensions.k8s.io/receivers.notification.toolkit.fluxcd.io</code></pre>
<p>Great! The Flux controllers are running and we have a bunch of new CustomResourceDefinitions available to us.
Read ahead to learn more about how those play together.</p>
<h3 id="the-gitops-repository">The GitOps repository</h3>
<p>To better understand how Flux works, let&rsquo;s now take a look at the directory structure of our bootstrapped GitOps
repository on Github. We&rsquo;re going to see that the bootstrap command has created some Kubernetes yamls for us.</p>
<pre class="command-line" data-user="leo" data-host="sldk.de" data-filter-output="out:"><code class="language-bash">git clone git@github.com:${username}/cluster-name.git
cd cluster-name
tree
out:.
out:‚îú‚îÄ‚îÄ cluster
out:‚îÇ   ‚îî‚îÄ‚îÄ flux-system
out:‚îÇ       ‚îú‚îÄ‚îÄ gotk-components.yaml
out:‚îÇ       ‚îú‚îÄ‚îÄ gotk-sync.yaml
out:‚îÇ       ‚îî‚îÄ‚îÄ kustomization.yaml
out:‚îî‚îÄ‚îÄ README.md
out:
out:2 directories, 4 files</code></pre>
<p>Cool. We&rsquo;ll go through the individual files.</p>
<h4 id="the-cluster-directory">The cluster directory</h4>
<p>This directory was created because we used <code>flux bootstrap ... --path cluster ...</code> during bootstrapping.
We&rsquo;ll see in a second that this folder is also special because it&rsquo;s being watched by the Flux <code>kustomization-controller</code>.</p>
<p>Any Kubernetes yaml that we throw in this directory will be deployed to our cluster. It also means that we can have
different files and directories in our repository that will never make it to the cluster. This is useful because we could
have one single git repository for our infrastructure declarations and divide it into sub-paths for different k8s clusters
or environments. For example, we could bootstrap multiple Flux environments and use paths like
<code>dev-cluster</code>, <code>stage-cluster</code>, <code>prod-cluster</code>.</p>
<p>That&rsquo;s just one way to organize. It&rsquo;s nice that we have this flexibility.</p>
<h4 id="the-flux-system-directory">The flux-system directory</h4>
<p>This directory represents the <code>flux-system</code> k8s namespace and contains Kubernetes declarations.</p>
<p>I like to continue this pattern and create a subdirectory for each namespace that I deploy with Flux.</p>
<p>Example:</p>
<pre><code>‚îî‚îÄ‚îÄ cluster
    ‚îú‚îÄ‚îÄ flux-system
    ‚îú‚îÄ‚îÄ monitoring
    ‚îú‚îÄ‚îÄ cool-app-namespace
    ‚îî‚îÄ‚îÄ monitoring
</code></pre><p>This isn&rsquo;t required. You&rsquo;re flexible and can structure the <code>/cluster</code> directory like you want!</p>
<h4 id="kustomizationyaml">kustomization.yaml</h4>
<p>As we can see Flux created a simple <code>kustomization.yaml</code> for us. If you&rsquo;re not familiar with <a href="https://kustomize.io/">Kustomize</a>
you can just ignore this for now. All it does is include the other two files in the <code>cluster/flux-system</code> directory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># cluster/flux-system/kustomization.yaml</span>
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kustomize.config.k8s.io/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Kustomization</span>
<span style="color:#f92672">resources</span>:
- <span style="color:#ae81ff">gotk-components.yaml</span>
- <span style="color:#ae81ff">gotk-sync.yaml</span>
</code></pre></div><h4 id="gotk-componentsyaml">gotk-components.yaml</h4>
<p>This file contains the <strong>G</strong>it<strong>O</strong>ps <strong>T</strong>ool<strong>K</strong>it components ü§Ø -
in here you will find the <em>Deployments</em> and <em>Services</em> for the Flux controllers and all the <em>CustomResourceDefinitions</em>
that we&rsquo;ve already seen when we inspected the <code>flux-system</code> namespace.</p>
<p>This file is generated by the <code>flux bootstrap</code> command and you shouldn&rsquo;t have to deal with it manually.</p>
<h4 id="gotk-syncyaml">gotk-sync.yaml</h4>
<p>The file <code>gotk-sync.yaml</code> is more interesting to us. This file declares our first two custom resources for Flux.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># cluster/flux-system/gotk-sync.yaml</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">source.toolkit.fluxcd.io/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">GitRepository</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">flux-system</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">flux-system</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">1m0s</span>
  <span style="color:#f92672">ref</span>:
    <span style="color:#f92672">branch</span>: <span style="color:#ae81ff">master</span>
  <span style="color:#f92672">secretRef</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">flux-system</span>
  <span style="color:#f92672">url</span>: <span style="color:#ae81ff">ssh://git@github.com/your-user-name-here/cluster-name</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kustomize.toolkit.fluxcd.io/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Kustomization</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">flux-system</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">flux-system</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">10m0s</span>
  <span style="color:#f92672">path</span>: <span style="color:#ae81ff">./cluster</span>
  <span style="color:#f92672">prune</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#f92672">sourceRef</span>:
    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">GitRepository</span>
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">flux-system</span>
  <span style="color:#f92672">validation</span>: <span style="color:#ae81ff">client</span>
</code></pre></div><p>Let&rsquo;s take a closer look at these two&hellip;</p>
<h4 id="the-flux-system-gitrepository">The flux-system GitRepository</h4>
<p>The first custom resource is of type <em>GitRepository</em>. A GitRepository is one of the possible <em>Sources</em> that are picked
up by the Flux <code>source-controller</code>.
Once a repository is registered with this controller, the Flux toolkit is able to watch it for changes
and notify other Flux controllers to apply the contents to the cluster.</p>
<p>This specific GitRepository definition tells Flux to check the <code>master</code> branch of our new GitOps repository
from <abbr title="ssh://git@github.com/${username}/cluster-name">Github</abbr>. every <code>1m0s</code> using a <code>flux-system</code> secret for authentication
(this secret contains your Github Personal Access Token that we created during bootstrapping).</p>
<p>Note that we could create more GitRepository resources and effectively sync any number of GitOps repositories with our
Flux-enabled cluster.</p>
<p>Example use-case: You have multiple teams that want to deploy to one cluster. You want each team to maintain their own
infrastructure repository. You could set up Flux on the cluster such that it pulls each team&rsquo;s repository.</p>
<p>Read more in the <a href="https://toolkit.fluxcd.io/components/source/gitrepositories/">Flux Docs</a>.</p>
<h4 id="the-flux-system-kustomization">The flux-system Kustomization</h4>
<p>The second custom resource in this file is a (Flux-) <strong>Kustomization</strong>.</p>
<p>‚ö†Ô∏è Not to be confused with a <a href="https://kustomize.io/"><strong>Kustomize</strong> resource</a>.</p>
<p>A Flux Kustomization describes a <em>path</em> inside of a <em>Source</em> that Flux should apply to the cluster. It&rsquo;s assumed
that there are Kubernetes yamls and/or Kustomize yamls located in the directory at the named path.</p>
<p>The Flux <code>kustomize-controller</code> is going to periodically apply the yamls at the given location to our cluster.</p>
<p>Here&rsquo;s a simplified walk-through of how the <code>kustomize-controller</code> is going to install our k8s resources.</p>
<ul>
<li>Checkout the configured branch from
<pre><code>ssh://git@github.com/${username}/cluster-name
</code></pre></li>
<li>Change the working directory to the specified path: <code>./cluster</code></li>
<li>Build a root <code>Kustomize</code> yaml at this location if no explicit one is available:
<pre><code>kustomize create --autodetect --recursive &gt; kustomization.yaml
</code></pre></li>
<li>Apply the result:
<pre><code>kubectl apply -k kustomization.yaml`
</code></pre></li>
</ul>
<p>I think it&rsquo;s good to know how <code>kustomize</code> is being used to build the final Kubernetes manifest from our GitOps repo.
The commands above can be used for testing locally. This is especially helpful when you mix plain Kubernetes yamls with
Kustomize yamls as this has an impact on the recursive auto-detection.</p>
<h2 id="deploying-own-resources">Deploying own resources</h2>
<p>Let&rsquo;s do a really simple example on how to deploy stuff to our cluster.</p>
<p>All we want to do is create a new namespace &ldquo;awesome-namespace&rdquo;.</p>
<pre class="command-line" data-user="leo" data-host="sldk.de" data-filter-output="out:"><code class="language-bash"># Create a new directory for our namespace
mkdir cluster/awesome-namespace

# Create the Kubernetes namespace descriptor
cat &lt;&lt;EOF &gt; cluster/awesome-namespace/namespace.yaml
out:---
out:apiVersion: v1
out:kind: Namespace
out:metadata:
out:  name: awesome-namespace
out:EOF

# Commit and push the change
git add .
git commit -m &#34;Add &#39;awesome-namespace&#39;&#34;
git push</code></pre>
<p>Lean back and watch as the new namespace is shipped to our cluster üõ≥Ô∏è</p>
<hr>
<h2 id="summary">Summary</h2>
<p>We installed the Flux GitOps toolkit to a Kubernetes cluster and deployed a Kubernetes manifest by only using <code>git</code>.
Along the way we learnt about the Flux components.</p>
<p>I hope this gave you an introduction on what Flux v2 is, how it works and how you can use it to enhance your CI/CD workflows.</p>
<p>I&rsquo;m planning to write more about this topic in the future. We&rsquo;ll take a look at how to
integrate <a href="https://github.com/mozilla/sops">SOPS</a> for secret handling, how to deploy
<a href="https://toolkit.fluxcd.io/components/source/helmcharts/">Helm Charts</a> and how to set up Flux notifications.</p>
<p>If you read this far, hit me up in the comments, on <a href="https://twitter.com/sladkovik">Twitter</a> or <a href="https://www.instagram.com/sladkoff2/">Instagram</a> to let me know how I did.</p>
<p>Thanks üôè</p>
]]></content></item><item><title>How I build my resume from Markdown</title><link>https://blog.sldk.de/2021/02/how-i-build-my-resume-from-markdown/</link><pubDate>Mon, 15 Feb 2021 00:00:00 +0000</pubDate><guid>https://blog.sldk.de/2021/02/how-i-build-my-resume-from-markdown/</guid><description>I was recently inspired to update my Software Engineering resume. The problem with that was that up until now my resume was a Word docx document that I would manually export as PDF and distribute. I used to always get frustrated when I had to touch this document because I hate formatting text in Word and/or Google Docs.
After stumbling upon this Techlead video on YouTube I was convinced that I didn&amp;rsquo;t need any fancy layouts for my CV anyway and that I would go with a minimalist plain-text approach.</description><content type="html"><![CDATA[<p>I was recently inspired to update my Software Engineering resume.
The problem with that was that up until now my resume was a Word <code>docx</code> document that I would manually export as PDF and distribute.
I used to always get frustrated when I had to touch this document because I <strong>hate</strong> formatting text in Word and/or Google Docs.</p>
<p>After stumbling upon this <a href="https://www.youtube.com/watch?v=xpaz7nrNmXA">Techlead video on YouTube</a> I was convinced that I didn&rsquo;t
need any fancy layouts for my CV anyway and that I would go with a minimalist plain-text approach.</p>
<p>If you&rsquo;re like me and you don&rsquo;t need pie charts on your resume, you might be asking:</p>
<blockquote>
<p>Why not write my resume in good old Markdown? Why not just make it open-source on Github as well?
Why not use Github Actions to build a distributable PDF version of it? ü§î</p>
</blockquote>
<p>Hey, that&rsquo;s what I did! And I find it pretty cool. So I recommend you do it, too. Here&rsquo;s why.</p>
<h2 id="the-opensource-markdown-resume-">The Opensource Markdown Resume ‚Ñ¢Ô∏è</h2>
<h3 id="easy-to-write-and-maintain">Easy to write and maintain!</h3>
<p>It&rsquo;s one file. It&rsquo;s simple <strong>af</strong>. I only used headings and bullet lists and decided that it was enough to get my points across.</p>
<p>You can see it on <a href="https://github.com/sladkoff/resume/edit/master/README.md">Github</a> and fork it or whatever.</p>
<h3 id="automated-pdf-export">Automated PDF export!</h3>
<p>I found this <a href="https://github.com/BaileyJM02/markdown-to-pdf">markdown-to-pdf</a> Github Action that exports - you guessed it - Markdown to PDF.
It renders the PDF with the default Github styling, so the result (<a href="https://github.com/sladkoff/resume/releases/tag/2021-02-13">preview available here</a>) looks very similar to the <a href="https://github.com/sladkoff/resume">web version</a>.</p>
<p>Here&rsquo;s the full annotated <a href="https://raw.githubusercontent.com/sladkoff/resume/master/.github/workflows/release.yml">Github Action</a> that I&rsquo;m using now:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">on</span>:
  <span style="color:#f92672">push</span>:
    <span style="color:#f92672">tags</span>:
      - <span style="color:#e6db74">&#39;*&#39;</span>                                                 <span style="color:#75715e"># (1)</span>

<span style="color:#f92672">name</span>: <span style="color:#ae81ff">Upload Release Asset</span>

<span style="color:#f92672">jobs</span>:
  <span style="color:#f92672">build</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Upload Release Asset</span>
    <span style="color:#f92672">runs-on</span>: <span style="color:#ae81ff">ubuntu-latest</span>
    <span style="color:#f92672">steps</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Checkout code</span>
        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/checkout@v2</span>
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Remove swag line                             </span> <span style="color:#75715e"># (2)</span>
        <span style="color:#f92672">run</span>: <span style="color:#ae81ff">sed -i &#39;1d&#39; README.md</span>
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Build PDF from Markdown                      </span> <span style="color:#75715e"># (3)</span>
        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">BaileyJM02/markdown-to-pdf@v1</span>
        <span style="color:#f92672">with</span>:
          <span style="color:#f92672">input_dir</span>: <span style="color:#ae81ff">.</span>
          <span style="color:#f92672">output_dir</span>: <span style="color:#ae81ff">out</span>
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Rename pdf</span>
        <span style="color:#f92672">run</span>: <span style="color:#ae81ff">cp out/README.pdf ./leonid_koftun_resume.pdf</span>
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Create Release                               </span> <span style="color:#75715e"># (4)</span>
        <span style="color:#f92672">id</span>: <span style="color:#ae81ff">create_release</span>
        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/create-release@v1</span>
        <span style="color:#f92672">env</span>:
          <span style="color:#f92672">GITHUB_TOKEN</span>: <span style="color:#ae81ff">${{ secrets.GITHUB_TOKEN }}</span>
        <span style="color:#f92672">with</span>:
          <span style="color:#f92672">tag_name</span>: <span style="color:#ae81ff">${{ github.ref }}</span>
          <span style="color:#f92672">release_name</span>: <span style="color:#ae81ff">Release ${{ github.ref }}</span>
          <span style="color:#f92672">draft</span>: <span style="color:#66d9ef">false</span>
          <span style="color:#f92672">prerelease</span>: <span style="color:#66d9ef">false</span>
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Upload Release Asset                         </span> <span style="color:#75715e"># (5)</span>
        <span style="color:#f92672">id</span>: <span style="color:#ae81ff">upload-release-asset</span>
        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/upload-release-asset@v1</span>
        <span style="color:#f92672">env</span>:
          <span style="color:#f92672">GITHUB_TOKEN</span>: <span style="color:#ae81ff">${{ secrets.GITHUB_TOKEN }}</span>
        <span style="color:#f92672">with</span>:
          <span style="color:#f92672">upload_url</span>: <span style="color:#ae81ff">${{ steps.create_release.outputs.upload_url }}</span>
          <span style="color:#f92672">asset_path</span>: <span style="color:#ae81ff">./leonid_koftun_resume.pdf</span>
          <span style="color:#f92672">asset_name</span>: <span style="color:#ae81ff">leonid_koftun_resume.pdf</span>
          <span style="color:#f92672">asset_content_type</span>: <span style="color:#ae81ff">application/pdf</span>
</code></pre></div><h4 id="annotations">Annotations</h4>
<ol>
<li>Build PDF when any tag is pushed</li>
<li>(Optional) This is just &lsquo;pre-processing&rsquo; to remove some HTML content that I don&rsquo;t want to be rendered to PDF (the first line of the Markdown contains some links that only make sense on the Github web view)</li>
<li>The actual <a href="https://github.com/BaileyJM02/markdown-to-pdf">markdown-to-pdf</a> step with minimal config</li>
<li>Creates a Github release for the tag</li>
<li>Uploads the generated PDF to the tagged release</li>
</ol>
<h3 id="the-opensource-aspect">The opensource aspect</h3>
<p>As you probably noticed by now, my resume is publicly available on Github.</p>
<p>Potential employers and recruiters can grab a copy there. My peers and colleagues can review it and tell me what I suck at the most (come at me).</p>
<h3 id="any-issues-with-this">Any issues with this?</h3>
<p>Yes.</p>
<ul>
<li>If you want to use fancy column layouts and colors and unicorns ü¶Ñ in your resume, then this probably isn&rsquo;t for you (you could make it complicated and add CSS and templating but that kind of defeats the purpose of simplicity in the <code>.md</code> approach IMO).</li>
<li>If you&rsquo;re afraid of me or one of my cats copying some lines from your own personal resume, I do not recommend that you make it public.</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<blockquote>
<p>Keep your resume simple by using Markdown, publish it on Github if you want to be a cool kid.</p>
</blockquote>
<p>What do you think of this nonsense? #hmu on <a href="https://twitter.com/sladkovik">Twitter</a> or <a href="https://www.instagram.com/sladkoff2/">Instagram</a>. ü§ô</p>
]]></content></item><item><title>Hosting static sites generated with Hugo</title><link>https://blog.sldk.de/2020/01/hosting-static-sites-generated-with-hugo/</link><pubDate>Sat, 25 Jan 2020 00:00:00 +0000</pubDate><guid>https://blog.sldk.de/2020/01/hosting-static-sites-generated-with-hugo/</guid><description>I&amp;rsquo;m using Hugo to generate a static website / blog from markdown.
This means that I have some source files on my local machine and I run hugo to generate static html/css files. Once I have these static files I needed to decide how to publish them to the internet.
This post is a subjective comparison of possible hosting solutions when working with Hugo.
Gitlab Pages My initial plan was to use Gitlab Pages because my source files are already checked into a private git repository on Gitlab.</description><content type="html"><![CDATA[<p>I&rsquo;m using <a href="https://gohugo.io/">Hugo</a> to generate a static website / blog from markdown.</p>
<p>This means that I have some source files on my local machine and I run <code>hugo</code> to generate static html/css files.
Once I have these static files I needed to decide how to publish them to the internet.</p>
<p>This post is a subjective comparison of possible hosting solutions when working with Hugo.</p>
<h2 id="gitlab-pages">Gitlab Pages</h2>
<p>My initial plan was to use <a href="https://about.gitlab.com/product/pages/">Gitlab Pages</a> because my source files are already checked into a private git repository on Gitlab.</p>
<p>I used a simple <code>.gitlab-ci.yaml</code> found on <a href="https://gitlab.com/pages/hugo:">https://gitlab.com/pages/hugo:</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.gitlab.com/pages/hugo:latest</span>

<span style="color:#f92672">variables</span>:
  <span style="color:#f92672">GIT_SUBMODULE_STRATEGY</span>: <span style="color:#ae81ff">recursive</span>

<span style="color:#f92672">pages</span>:
  <span style="color:#f92672">script</span>:
  - <span style="color:#ae81ff">hugo</span>
  <span style="color:#f92672">artifacts</span>:
    <span style="color:#f92672">paths</span>:
    - <span style="color:#ae81ff">public</span>
  <span style="color:#f92672">only</span>:
  - <span style="color:#ae81ff">master</span>
</code></pre></div><p>This would run on my master branch and publish the generated content to Gitlab Pages.
The setup is simple and everything was in one place, a custom domain can be used and we get a Let&rsquo;s Encrypt TLS certificate as well.</p>
<p>What made me look for an alternative solution? Two things:</p>
<ul>
<li>For some reason I could not get custom 404 pages to work with this setup. When accessing a non-existent URL it would always
load a generic Gitlab 404 page instead of my custom Hugo one. It may be related to this <a href="https://gitlab.com/gitlab-org/gitlab-pages/issues/183">issue</a>.</li>
<li>The loading times seemed atrociously slow for what I was serving üêå. 5-10 seconds on an empty cache was quite a deal-breaker.</li>
</ul>
<h2 id="github-pages">Github Pages</h2>
<p>Everybody and their mom has a Github account. Github also has <a href="https://pages.github.com/">Pages</a>. So I tried out hosting my hugo content there.</p>
<p>The setup is not so elegant anymore. I followed the instructions on <a href="https://gohugo.io/hosting-and-deployment/hosting-on-github/">https://gohugo.io/hosting-and-deployment/hosting-on-github/</a> and ended up with <strong>two</strong> git repos.
One for my source files (I used my existing Gitlab repo) and one for the generated content under <code>/public</code> which needs to be set up as a git submodule.</p>
<p>This could still be automated with Gitlab CI pretty easily with something like (not tested):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.gitlab.com/pages/hugo:latest</span>

<span style="color:#f92672">variables</span>:
  <span style="color:#f92672">GIT_SUBMODULE_STRATEGY</span>: <span style="color:#ae81ff">recursive</span>

<span style="color:#f92672">github-pages</span>:
  <span style="color:#f92672">script</span>:
  - <span style="color:#ae81ff">hugo</span>
  - <span style="color:#ae81ff">cd public &amp;&amp; git -am &#34;Build for Github Pages&#34; &amp;&amp; git push</span>
  <span style="color:#f92672">artifacts</span>:
    <span style="color:#f92672">paths</span>:
    - <span style="color:#ae81ff">public</span>
  <span style="color:#f92672">only</span>:
  - <span style="color:#ae81ff">master</span>
</code></pre></div><p>This tells Gitlab to build the static page and then push the git submodule to Github as well.</p>
<p>Github Pages were subjectively faster but there are downsides:</p>
<ul>
<li>I still didn&rsquo;t get a custom 404 page üò•</li>
<li>I don&rsquo;t like having one repo for the source and one for the generated content</li>
<li>Github Pages works only with <strong>public</strong> repositories (unless you have a paid account AFAIK)</li>
</ul>
<h2 id="netlify">Netlify</h2>
<p>I haven&rsquo;t heard of <a href="https://www.netlify.com/">Netlify</a> before. I think it came up in some Gitlab issue while I was looking for alternatives.</p>
<p>I used their web UI to set everything up but I read that there&rsquo;s also a CLI available which should be cool.
Anyway, I just had to connect my Gitlab account and select the source repository which I had already been working on.</p>
<p>Netlify automagically recognized that the contents of the repo had to be build with hugo and suggested that for the build options:</p>

    <img src="/img/posts/netlify_screenshot.png"  alt="Netlify wizard"  class="center"  style="border-radius: 8px;"  />


<p>Whenever I push to <code>master</code> in Gitlab a hook on Netlify builds and publishes the site. I could get rid of the <code>.gitlab-ci.yml</code> altogether.</p>
<p>I like about this setup:</p>
<ul>
<li>I have <strong>one private</strong> git repo on Gitlab</li>
<li>I haven&rsquo;t had issues with loading times on Netlify so far</li>
</ul>
<p>I understand that there could be one big downside to this approach for other people.
On Gitlab / Github you get a cool <code>xyz.gitlab.io</code> / <code>xyz.github.io</code> domain for free.
A free <code>xyz.netfliy.com</code> domain is not so cool for a tech blog - so I&rsquo;d say that you <strong>need</strong> a custom domain if you choose to go that route.</p>
<h2 id="conclusion">Conclusion</h2>
<p>If you&rsquo;re using hugo to generate your static site, you can use Gitlab Pages, Github Pages and Netlify as a hosting provider quite easily.</p>
<p>Gitlab turned out to have slow loading times. Github requires a weird repo / branching setup. Netlify works nicely together with Gitlab but
you&rsquo;ll probably want a custom domain.</p>
<table>
<thead>
<tr>
<th></th>
<th>Loading Times (cold cache)</th>
<th>Private Repo</th>
<th>Domains</th>
<th>TLS</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Gitlab Pages</strong></td>
<td>~5s ‚õî</td>
<td>Yes</td>
<td>.gitlab.io, custom</td>
<td>Let&rsquo;s Encrypt</td>
</tr>
<tr>
<td><strong>Github Pages</strong></td>
<td>&lt;1s</td>
<td>No ‚õî</td>
<td>.github.io, custom</td>
<td>Let&rsquo;s Encrypt</td>
</tr>
<tr>
<td><strong>Netlify</strong></td>
<td>&lt;1s</td>
<td>Yes</td>
<td>.netlify.com, custom</td>
<td>Let&rsquo;s Encrypt</td>
</tr>
</tbody>
</table>
]]></content></item></channel></rss>